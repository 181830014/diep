<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="lib/jquery.min.js"> </script>
  <script src="lib/jcanvas.min.js"></script>
  <script src="lib/createjs.min.js"></script>
  <script src="lib/widget.js"></script>
  <script src="lib/vue.min.js"></script>
  <script type="text/javascript">
  	// 忽略ctrl+滚轮缩放事件
  	// others
	window.addEventListener('mousewheel', function(event) {
	  if (event.ctrlKey === true || event.metaKey) {
	    event.preventDefault();
	  }
	}, {passive: false});
	// firefox
	window.addEventListener('DOMMouseScroll', function(event) {
		if (event.ctrlKey === true || event.metaKey) {
		  event.preventDefault();
		}
	}, {passive: false}); 
  </script>
  <link rel="stylesheet" type="text/css" href="stylesheets/index_login.css">
</head>


<div id="js-game" class="game-container" v-bind:class="{'hide':gameState!=3}">
    <div id="js-container">
        <div id="js-kill-bd" class="game-kill-borad">
            <!--<div class="kill-line">
                <span>YOU</span> <a>killed</a> <span>AGSFS</span>
            </div>-->
        </div>
    </div>
</div>
<div id="js-main-page" class="main-page" v-bind:class="{'hide':gameState>=2}">
    <div id="login-page" class="login-page">
        <div class="input-cont">
            <input id="name-box" type="text" maxlength="30" v-on:keyup.13="login()" v-model="nickname" placeholder="input your name" />
            <div id="btn-start" class="btn-start" v-on:click="login()">
                <span>Start !</span>
                <div id="connecting-img" class="connecting-img" v-bind:class="{'show':gameState==1}"></div>
            </div>
        </div>
    </div>
</div>

<body style="overflow:-Scroll; overflow-x:hidden; overflow-y:hidden; height:100%"> 
<canvas id="Hcanvas"></canvas>
<canvas id="canvas" height="2000" width="2000" style="background-color:gainsboro;"></canvas>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script>
  var pageVueData = {
    nickname: '',
    gameState: 0 // 0表示未开始 1表示等待连接 2表示游戏运行中 3表示玩家坦克死亡
    // other attrs ...
  }
  var pageVue = new Vue({
    el: '#js-main-page',
    data: pageVueData,
    methods: {
      login: function () {
        if (pageVueData.gameState != 0) return;
        pageVueData.gameState = 1;
        socket.emit('name', ['name', pageVueData.nickname]);
        setTimeout('gameStart()', "10");
      }
    }
  });
  var deathPageVue = new Vue({
    el: '#js-game',
    data: pageVueData,
    methods: {}
  });
  // ------------以下是服务器拒绝登入后应触发的过程实例---------------
  function accessDenied() {
    pageVueData.nickname = '';
    pageVueData.gameState = 0;
  }
  // ------------以下是服务器准许登入后应触发的过程实例---------------
  function gameStart(nickname) {
    // $('#login-page').style.display="none";
    // $('#login-page').remove();
    pageVueData.gameState = 2;
    // alert(pageVueData.nickname);
  }
  // ------------killed -------------------------------------------
  var js_kill_bd = $("#js-kill-bd");
  function gui_top_msg(htmlstr) {
      var hdom = $("<div class='kill-line'>"+htmlstr+"</div>");
      js_kill_bd.append(hdom);
      setTimeout(function () {
          hdom.css("margin-top", "-" + (hdom.height() + 3) + "px");
      },2700);
      setTimeout(function () {
          hdom.remove();
      }, 3000);
      setTimeout(function () {
          pageVueData.nickname = '';
          pageVueData.gameState = 0;
          window.location.reload(true);
      }, 4000);
  }
  function gui_show_kill(a, b) {
      gui_top_msg("<span>" + a + "</span><a>killed</a><span>" + b + "</span>");
  }

  var socket = io();

  var canvas = document.getElementById('canvas');
  var Hcanvas = document.getElementById('Hcanvas');

  var ctx = canvas.getContext('2d');
  var cvsBox = canvas.getBoundingClientRect();
  var stage = new createjs.Stage('canvas');
  const FRAME_RATE = 60;
  createjs.Ticker.framerate = FRAME_RATE;

  const BODY_WIDTH = window.innerWidth;
  const BODY_HEIGHT = window.innerHeight;

  const CANVAS_LEFT = 50;
  const CANVAS_BOTTOM = 50;
  const CANVAS_RIGHT = canvas.clientWidth - 50;
  const CANVAS_TOP = canvas.clientHeight - 50;
  const CANVAS_WIDTH = canvas.clientWidth;
  const CANVAS_HEIGHT = canvas.clientHeight;

  const STAGE_WIDTH = canvas.clientWidth + 80;     // TODO: change
  const STAGE_HEIGHT = canvas.clientHeight + 80;

  const MAX_PLAYER_NUMBER = 30;
  const MAX_TANK_GRADE = 30;
  const KEYBOARD_UP = 87;
  const KEYBOARD_DOWN = 83;
  const KEYBOARD_LEFT = 65;
  const KEYBOARD_RIGHT = 68;

  var KEYBOARD_CONDITION = 0;   // 0000 UP DOWN LEFT RIGHT
  var banKeyBoard = false;
  // tools
  var tools = {};

  tools.deg2Rad = function(deg) {
    return (deg % 360) * (Math.PI / 180);
  };

  tools.vec2Deg = function () {
    var radianToDegreesFactor = 180 / Math.PI;
    return function (x, y) {
      if (x == 0 && y == 0) {
        return 360;
      }
      rad = Math.atan(y / x);
      var result = rad * radianToDegreesFactor;
      if (x < 0) {
        result += 180;
      }
      if (result < 0) {
        result += 360;
      }
      return result;
    }
  }();


  var modelList = [];
  var tankList = [];
  var creepList = [];
  var bulletList = [];
  var tripList = [];
  var tankMap = new Object();
  var creepMap = new Object();
  var bulletMap = new Object();
  var collideTime = new Object();

  var levelUpThreshold = [0];
  for(let i = 1; i <= 30; i++)
    levelUpThreshold.push(i * 100 + 500);

  // Global part
  function justifyPosition(obj) {
    if(obj.model.x + obj.r * obj.model.scaleX > CANVAS_RIGHT)
      obj.model.x = CANVAS_RIGHT - obj.r * obj.model.scaleX;
    if(obj.model.x - obj.r * obj.model.scaleX < CANVAS_LEFT)
      obj.model.x = CANVAS_LEFT + obj.r * obj.model.scaleX;
    if(obj.model.y + obj.r * obj.model.scaleX > CANVAS_TOP)
      obj.model.y = CANVAS_TOP - obj.r * obj.model.scaleX;
    if(obj.model.y - obj.r * obj.model.scaleX < CANVAS_BOTTOM)
      obj.model.y = CANVAS_BOTTOM + obj.r * obj.model.scaleX;
  }

  function isNear(obj1, obj2) {
    if(obj1.armsId == obj2.armsId)
      return false;
    let x1 = obj1.model.x, y1 = obj1.model.y;
    let x2 = obj2.model.x, y2 = obj2.model.y;
    return Math.abs(y2 - y1) <= (BODY_HEIGHT >> 1) &&
            Math.abs(x2 - x1) <= (BODY_WIDTH >> 1);
  }

  function isCollided(obj1, obj2) {
    if(obj1.armsId == obj2.armsId)
      return false;
    if(obj1.type == 1 && obj2.type == 1)
      return false;
    let dx = obj1.model.x - obj2.model.x;
    let dy = obj1.model.y - obj2.model.y;
    let dis = dx * dx + dy * dy;
    let sumr = obj1.r * obj1.model.scaleX + obj2.r * obj2.model.scaleX;
    return dis <= sumr * sumr;
  }

  function checkCollision(obj1, obj2) { // modify parameter
    
    let id1 = Math.min(obj1.armsId, obj2.armsId);
    let id2 = Math.max(obj1.armsId, obj2.armsId);
    let nowTime = new Date();
    let preTime = collideTime[String(id1) + String(id2)];
    if(!preTime) preTime = nowTime - 10000;
    if(nowTime - preTime < 65) return;
    collideTime[String(id1) + String(id2)] = nowTime;

    res = isCollided(obj1, obj2);
    if(res == false)
      return false;

    if(obj1.armsId == maintk.armsId || obj2.armsId == maintk.armsId) 
      outWarStartTime = new Date();
    obj1.healthDrop(obj2.bodyDamage);
    obj2.healthDrop(obj1.bodyDamage);
    
    if(obj2.healthPoint <= 0)
    {
      if(obj1.type == 0)       // tank
        obj1.experienceUp(obj2.bonus);
      else if(obj1.type == 1)  // bullet
        tankMap[obj1.belong].experienceUp(obj2.bonus);
    }
    if(obj1.healthPoint <= 0)
    {
      if(obj2.type == 0)       // tank
        obj2.experienceUp(obj1.bonus);
      else if(obj2.type == 1)  // bullet
        tankMap[obj2.belong].experienceUp(obj1.bonus);
    }

    if(obj1.type == 2 || obj2.type == 2) {
      // TODO: maintk 碰撞动画 & 其他参数修改
      let creep = null, tank = null;
      if(obj1.type == 2) creep = obj1, tank = obj2;
      else if(obj2.type == 2) creep = obj2, tank = obj1;
      console.log('collide = ', creep.armsId);
      if(creep) {
        let destX = creep.model.x + tank.xMoveSpeed * 10;
        let destY = creep.model.y + tank.yMoveSpeed * 10;
        let tempCreep = new Creep(destX, destY, creep.armsId);
        justifyPosition(tempCreep);
        destX = tempCreep.model.x, destY = tempCreep.model.y;
        socket.emit('collide', ['collide', creep.armsId, destX, destY]);
      }
    }

    return true;
  }


  // BaseModel part
  function BaseModel (modelX, modelY, armsId = 0) {
    this.model = new createjs.Container();
    this.headAttrs = [];
    /*
      this.headAttrs = [
        {
          outerRadius:  number,
          type:         "Gun"/"Auto"/"Launcher"/"Smasher"/"Factory",
          layer:        "Top"/"Bottom"
        }
      ];
    */
    this.headShapes = [];
    /*
      this.headShapes :: Array of createjs.Shape
    */
    this.heads = new createjs.Container();
    /* 
      this.heads :: A container of all cursor-following heads
    */
    this.body = new createjs.Shape();
    this.health = new createjs.Shape();
    this.status = new createjs.Text();

    this.type = 0;
    this.offset = 0;
    this.model.x = modelX;
    this.model.y = modelY;
    this.model.scaleX = 0.8;
    this.model.scaleY = 0.8;
    this.armsId = armsId;
    this.bodyStrokeColor = '#000';
    this.bodyFillColor = '#000';
    this.r = 0;
    this.name = '';

    this.setBodyColor('', '', 1);
    this.decorate(this.armsId);
  }

  BaseModel.prototype.setBodyColor = function (strokeColor, fillColor, builtInColorStyle = 0) {
    switch(builtInColorStyle) {
      case 1: this.bodyStrokeColor = '#1f90ae', this.bodyFillColor = '#00b2e1'; break;
      case 2: this.bodyStrokeColor = '#bfae4e', this.bodyFillColor = '#ffe869'; break;
      case 3: this.bodyStrokeColor = '#c28081', this.bodyFillColor = '#fc7677'; break;
      case 4: this.bodyStrokeColor = '#5869bd', this.bodyFillColor = '#768dfc'; break;
      case 5: this.bodyStrokeColor = '#b43a3f', this.bodyFillColor = '#f14e54'; break;
      default: this.bodyStrokeColor = strokeColor, this.bodyFillColor = fillColor;
    }
  }

  BaseModel.prototype.decorate = function (armsId) {
    // 坦克组件
    this.headDecorate((armsId >> 4) & 63);
    this.bodyDecorate(armsId & 3);
    this.model.removeAllChildren();
    this.model.addChild(this.heads);
    for(let i = 0; i < this.headAttrs.length; i++) if(this.headAttrs[i].layer === "Bottom") {
        if(this.headAttrs[i].type === "Smasher") {
          createjs.Ticker.addEventListener('tick', $.proxy(function() {
              this.headShapes[i].rotation += 1;
            }, this));
          this.model.addChild(this.headShapes[i]);
        }
        else if(this.headAttrs[i].type === "Auto")
          this.model.addChild(this.headShapes[i]);
        else 
          this.heads.addChild(this.headShapes[i]);
    } 
    this.model.addChild(this.body);
    for(let i = 0; i < this.headAttrs.length; i++) if(this.headAttrs[i].layer === "Top")
      this.model.addChild(this.headShapes[i]);
    this.model.addChild(this.health, this.status);
    // 信息组件
    if(((armsId >> 2) & 3) != 1) {
      // 不是子弹，画血条
      this.health.graphics.clear().f('#555555').rr(-30, this.r  + 10, 60, 8, 4);
      this.health.graphics.f('#85e37d').rr(-28, this.r  + 12, 56, 4, 2);
    }
    if(((armsId >> 2) & 3) == 0) {
      // 是坦克，画状态 [未启用]
      this.status.text = this.name;
      this.status.font = 'bold 20px Ubuntu';
      this.status.color = '#000000';
      this.status.x = 0;
      this.status.y = -this.r - 30;
      this.status.textAlign = 'center';
      this.status.visible = false;
    }
    this.setHealthCond(1.0);
    this.armsId = armsId;
  }

  BaseModel.prototype.headDecorate = function (headId) {
    this.headShapes.length = 0;
    this.headAttrs.length = 0;
    this.heads.removeAllChildren();

    switch(headId) {
      case 0: // 无炮管
        break;
      case 1: // Tank
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 60, 30);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 30});
        break;
      case 2: // Sniper
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 70, 30);
        this.headAttrs.push({outerRadius: 70, type: "Gun", layer: "Bottom", r: 30});
        break;
      case 3: // Flank Guard
        this.headShapes.push(new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 60, 30);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 30});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 45, 30);
        this.headShapes[1].rotation = 180;
        this.headAttrs.push({outerRadius: 45, type: "Gun", layer: "Bottom", r: 30});
        break;
      case 4: // Twin
        this.headShapes.push(new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -28, 60, 25);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 25});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, 3, 60, 25);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 25});
        this.offset = 10;
        break;
      case 5: // Smasher
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#727272').dp(0, 0, 36, 6, 0, 0);
        this.headAttrs.push({outerRadius: 0, type: "Smasher", layer: "Bottom", r: 0});
        this.r = 34; // XXX:
        break;
      case 6: // Hunter
        this.headShapes.push(new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -13, 70, 26);
        this.headAttrs.push({outerRadius: 70, type: "Gun", layer: "Bottom", r: 26});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, -18, 60, 36);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 36});
        break;
      case 7: // Trapper
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dp(40, 0, 28, 3, 0, 60).dr(0, -14, 36, 28);
        this.headAttrs.push({outerRadius: 54, type: "Launcher", layer: "Bottom", r: 30});
        break;
      case 8: // Assassin
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 80, 30);
        this.headAttrs.push({outerRadius: 80, type: "Gun", layer: "Bottom", r: 30});
        break;
      case 9: // Destroyer
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -20, 54, 40);
        this.headAttrs.push({outerRadius: 54, type: "Gun", layer: "Bottom", r: 40});
        break;
      case 10: // Tri-Angle
        this.headShapes.push(new createjs.Shape(), new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 60, 30);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 30});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, -13, 50, 26);
        this.headShapes[1].rotation = 150;
        this.headAttrs.push({outerRadius: 50, type: "Gun", layer: "Bottom", r: 26});
        this.headShapes[2].graphics.ss(4).s('#727272').f('#999999').dr(0, -13, 50, 26);
        this.headShapes[2].rotation = 210;
        this.headAttrs.push({outerRadius: 50, type: "Gun", layer: "Bottom", r: 26});
        break;
      case 11: case 15:// Quad Tank
        this.headShapes.push(new createjs.Shape(), new createjs.Shape(), new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 60, 30);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 30});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 60, 30);
        this.headShapes[1].rotation = 90;
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 30});
        this.headShapes[2].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 60, 30);
        this.headShapes[2].rotation = 180;
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 30});
        this.headShapes[3].graphics.ss(4).s('#727272').f('#999999').dr(0, -15, 60, 30);
        this.headShapes[3].rotation = 270;
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 30});
        break;
      case 12: case 16: // Twin Flank
        this.headShapes.push(new createjs.Shape(), new createjs.Shape(), new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -28, 60, 25);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 25});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, 3, 60, 25);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 25});
        this.headShapes[2].graphics.ss(4).s('#727272').f('#999999').dr(0, -28, 60, 25);
        this.headShapes[2].rotation = 180;
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 25});
        this.headShapes[3].graphics.ss(4).s('#727272').f('#999999').dr(0, 3, 60, 25);
        this.headShapes[3].rotation = 180;
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 25});
        this.offset = 10;
        break;
      case 13: // Auto3
        this.headShapes.push(new createjs.Shape(), new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(24, -8, 30, 16)
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dc(24, 0, 14);
        this.headAttrs.push({outerRadius: 50, type: "Auto", layer: "Bottom", r: 16});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(24, -8, 30, 16);
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dc(24, 0, 14);
        this.headShapes[1].rotation = 120;
        this.headAttrs.push({outerRadius: 50, type: "Auto", layer: "Bottom", r: 16});
        this.headShapes[2].graphics.ss(4).s('#727272').f('#999999').dr(24, -8, 30, 16);
        this.headShapes[2].graphics.ss(4).s('#727272').f('#999999').dc(24, 0, 14);
        this.headShapes[2].rotation = 240;
        this.headAttrs.push({outerRadius: 50, type: "Auto", layer: "Bottom", r: 16});
        break;
      case 14: // Triple Shot
        this.headShapes.push(new createjs.Shape(), new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -10, 50, 20);
        this.headAttrs.push({outerRadius: 50, type: "Gun", layer: "Bottom", r: 20});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, -10, 50, 20);
        this.headShapes[1].rotation = 315;
        this.headAttrs.push({outerRadius: 50, type: "Gun", layer: "Bottom", r: 20});
        this.headShapes[2].graphics.ss(4).s('#727272').f('#999999').dr(0, -10, 50, 20);
        this.headShapes[2].rotation = 45;
        this.headAttrs.push({outerRadius: 50, type: "Gun", layer: "Bottom", r: 20});
        break;
      case 17: // Gunner
        this.headShapes.push(new createjs.Shape(), new createjs.Shape(), new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -30, 50, 15);
        this.headAttrs.push({outerRadius: 50, type: "Gun", layer: "Bottom", r: 15});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#999999').dr(0, 15, 50, 15);
        this.headAttrs.push({outerRadius: 50, type: "Gun", layer: "Bottom", r: 15});
        this.headShapes[2].graphics.ss(4).s('#727272').f('#999999').dr(0, -18, 60, 15);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 15});
        this.headShapes[3].graphics.ss(4).s('#727272').f('#999999').dr(0, 3, 60, 15);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom", r: 15});
        break;
      case 18: // Landmine
        this.headShapes.push(new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#727272').dp(0, 0, 34, 12, 0.1, 0);
        this.headAttrs.push({outerRadius: 0, type: "Smasher", layer: "Bottom", r: 0});
        this.model.scaleX = this.model.scaleY = 1.0;
        this.r = 34; // XXX:
        break;
      case 19: // Auto Smasher
        this.headShapes.push(new createjs.Shape(), new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dr(0, -10, 40, 20);
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999').dc(0, 0, 18);
        this.headAttrs.push({outerRadius: 24, type: "Auto", layer: "Top", r: 20});
        this.headShapes[1].graphics.ss(4).s('#727272').f('#727272').dp(0, 0, 36, 6, 0, 0);
        this.headAttrs.push({outerRadius: 0, type: "Smasher", layer: "Bottom", r: 0});
        this.r = 34; // XXX:
        break;
      case 20: // Spike
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#727272').dp(0, 0, 38, 12, 0.2, 0);
        this.headAttrs.push({outerRadius: 0, type: "Smasher", layer: "Bottom", r: 0});
        this.model.scaleX = this.model.scaleY = 0.75;
        this.r = 34; // XXX:
        break;
      case 21: // Shield Smasher
        break;
      // ==========================================================
      case 101: // 梯形炮管 * 1
        this.headShapes.push(new createjs.Shape());
        this.headShapes[0].graphics.ss(4).s('#727272').f('#999999');
        this.headShapes[0].graphics.mt(-30, 0).lt(60, -20).mt(58, -20).lt(58, 20).mt(60, 20).lt(-30, 0);
        this.headAttrs.push({outerRadius: 60, type: "Gun", layer: "Bottom"});
        break;
      default:
        alert('How can you reach here H?');
        break;
    }
  }

  BaseModel.prototype.bodyDecorate = function (bodyId) {
    this.body.graphics.clear().ss(4).s(this.bodyStrokeColor).f(this.bodyFillColor);
    if(((this.armsId >> 2) & 3) == 3) {
      this.body.graphics.dp(0, 0, 16, 3, 0.65, 0);
      this.r = 10;
      return;
    }
    switch(bodyId) {
      case 0: // 圆形底座
        this.body.graphics.dc(0, 0, 30); this.r = 30;
        break;
      case 1: // 方形底座
        this.body.graphics.dr(-20, -20, 40, 40);
        this.r = 20; break;
      case 2: // 正三角形
        this.body.graphics.dp(0, 0, 20, 3, 0, 0);
        this.r = 10; break;
      case 3: // 正五边形
        this.body.graphics.dp(0, 0, 40, 5, 0, 0);
        this.r = 32.4; break;
      default:
        alert('How can you reach here B?'); break;
    }
  }

  BaseModel.prototype.setHealthCond = function (ratio) {
  if(ratio < 0.0 || ratio > 1.0) return;
  if(((this.armsId >> 2) & 3) != 1) {
    // 不是子弹，画血条
    this.health.graphics.clear().f('#555555').rr(-30, this.r  + 10, 60, 8, 4);
    this.health.graphics.f('#85e37d').rr(-28, this.r  + 12, 56 * ratio, 4, 2);
  }
}
  

  // GeneralModel part
  function GeneralModel (modelX, modelY, armsId) {
    BaseModel.call(this, modelX, modelY, armsId);
    this.type = 0;
    this.bonus = 800;
    this.healthPoint = 100;
    this.maxHealthPoint = 100;
    this.xMoveSpeed = 0;
    this.yMoveSpeed = 0;
    this.maxMoveSpeed = 5;
    this.bodyDamage = 1;

    this.nearTank = [];
    this.nearCreep = [];
    this.nearBullet = [];
  }

  GeneralModel.prototype = new BaseModel();
  GeneralModel.prototype.constructor = GeneralModel;

  GeneralModel.prototype.healthDrop = function(damage) {
    this.healthPoint -= damage;
    if(this.healthPoint < 0)
      this.healthPoint = 0;
    socket.emit('HPdrop', ['HPdrop', this.armsId, this.healthPoint]);
    // this.setHealthCond(this.healthPoint / this.maxHealthPoint);
    if(this.healthPoint <= 0) {
      stage.removeChild(this.model);
      createjs.Tween.removeTweens(this.model);
      socket.emit('killed', ['killed', this.armsId]);
    }
  }

  GeneralModel.prototype.getNearTank = function() {
    this.nearTank = [];
    for(let i = 0; i < tankList.length; i++)
      if(isNear(this, tankList[i]))
        this.nearTank.push(tankList[i].armsId);
  }

  GeneralModel.prototype.getNearCreep = function() {
    this.nearCreep = [];
    for(let i = 0; i < creepList.length; i++)
      if(isNear(this, creepList[i]))
        this.nearCreep.push(creepList[i].armsId);
  }

  GeneralModel.prototype.getNearBullet = function() {
    this.nearBullet = [];
    for(let i = 0; i < bulletList.length; i++)
      if(isNear(this, bulletList[i]))
        this.nearBullet.push(bulletList[i].armsId);
  }

  GeneralModel.prototype.packageInfo = function() {
    // TODO: package infomation
    return this;
  }

  // Tank part
  function Tank (modelX, modelY, armsId = 0) {
    GeneralModel.call(this, modelX, modelY, armsId);
    this.type = 0;
    this.score = 0;
    this.level = 1;
    this.baseAlpha = 1;
    this.experience = 0;
    this.bulletReloadInterval = 1000;
    this.maxBulletSpeed = 5;
    this.bulletDamage = 30;
    this.regenerationRate = 10;
  }

  Tank.prototype = new GeneralModel();
  Tank.prototype.constructor = Tank;

  Tank.prototype.levelUp = function() {
    if(this.level == MAX_TANK_GRADE)
      return;
    this.level ++;
    Hstage.removeChild(bm.model);
    Hstage.addChild(bm.model);
    bm.clickNum ++;
    bm.slipIn();
    if(this.level == 2) {
      Hstage.removeChild(updmenu.model);
      Hstage.addChild(updmenu.model);
      updmenu.slipIn();
    }
    else if(this.level == 5) {
      switch((this.armsId >> 4) & 63) {
        case 2: updmenu.setItemOnShow(0, 6<<4, 'Hunter');
                updmenu.setItemOnShow(1, 7<<4, 'Trapper');
                updmenu.setItemOnShow(2, 8<<4, 'Assassin');
                updmenu.setItemOnShow(3, 9<<4, 'Destroyer');
                break;
        case 3: updmenu.setItemOnShow(0, 10<<4, 'Tri-Angle');
                updmenu.setItemOnShow(1, 11<<4, 'Quad Tank');
                updmenu.setItemOnShow(2, 12<<4, 'Twin Flank');
                updmenu.setItemOnShow(3, 13<<4, 'Auto3');
                break;
        case 4: updmenu.setItemOnShow(0, 14<<4, 'Triple');
                updmenu.setItemOnShow(1, 15<<4, 'Quad Tank');
                updmenu.setItemOnShow(2, 16<<4, 'Twin Flank');
                updmenu.setItemOnShow(3, 17<<4, 'Gunner');
                break;
        case 5: updmenu.setItemOnShow(0, 18<<4, 'Landmine');
                updmenu.setItemOnShow(1, 19<<4, 'Auto Sma');
                updmenu.setItemOnShow(2, 20<<4, 'Spike');
                updmenu.setItemOnShow(3, 21<<4, 'Shield Sma');
                break;
        default: return;
      }
      updmenu.slipIn();
    }
  }

  Tank.prototype.experienceUp = function(exp) {
    this.score += exp;
    if(this.level == MAX_TANK_GRADE)
      return;
    this.experience += exp;
    if(this.experience >= levelUpThreshold[this.level]) {
      this.experience -= levelUpThreshold[this.level];
      this.levelUp();
    }
    iw.animateExp(this.level, this.experience / levelUpThreshold[this.level]);
    iw.setScore(this.score);
  }

  Tank.prototype.tankMove = function() {
    if(this.healthPoint <= 0)
      return;
    this.xMoveSpeed = 0;
    this.yMoveSpeed = 0;
    if(banKeyBoard == true)
      return;
    if(KEYBOARD_CONDITION & 8) this.yMoveSpeed = -this.maxMoveSpeed;
    if(KEYBOARD_CONDITION & 4) this.yMoveSpeed = this.maxMoveSpeed;
    if(KEYBOARD_CONDITION & 2) this.xMoveSpeed = -this.maxMoveSpeed;
    if(KEYBOARD_CONDITION & 1) this.xMoveSpeed = this.maxMoveSpeed;

    if(this.xMoveSpeed != 0 && this.yMoveSpeed != 0) {
      this.xMoveSpeed *= Math.sqrt(2) / 2;
      this.yMoveSpeed *= Math.sqrt(2) / 2;
    }

    this.xMoveSpeed = this.xMoveSpeed * 30 / FRAME_RATE;
    this.yMoveSpeed = this.yMoveSpeed * 30 / FRAME_RATE;

    this.model.x += this.xMoveSpeed;
    this.model.y += this.yMoveSpeed;
    justifyPosition(this);

    socket.emit('move', ['move', this.armsId, this.model.x, this.model.y]);

    if(!banKeyBoard) {
      for (let i = 0; i < tankList.length; i++) {
        if (checkCollision(this, tankList[i]) == true)
          return;
      }
      for (let i = 0; i < creepList.length; i++) {
        if (checkCollision(this, creepList[i]) == true)
          return;
      }
      for (let i = 0; i < tripList.length; i++) {
        if (tripList[i].belong != maintk.armsId && checkCollision(this, tripList[i]) == true)
          return;
      }
    }
  }

  Tank.prototype.fireBullet = function() {
    if(this.healthPoint <= 0) return;
    for(let i = 0; i < this.headShapes.length; i++) {
      if(this.headAttrs[i].type == 'Auto' || this.headAttrs[i].type == 'Smasher')
        continue;
      outWarStartTime = new Date();
      let angle = tools.deg2Rad(this.heads.rotation + this.headShapes[i].rotation);
      let bulletX = this.model.x + this.headAttrs[i].outerRadius * Math.cos(angle);
      let bulletY = this.model.y + this.headAttrs[i].outerRadius * Math.sin(angle);
      let multi = (i&1)?-1:1;
      bulletX += multi * this.offset * Math.cos(angle + 90);
      bulletY += multi * this.offset * Math.sin(angle + 90);
      let xMoveSpeed = this.maxBulletSpeed * Math.cos(angle);
      let yMoveSpeed = this.maxBulletSpeed * Math.sin(angle);
      let radius = this.headAttrs[i].r;
      if(this.headAttrs[i].type == 'Gun')
        socket.emit('fire', ['fire', bulletX, bulletY, 0, this.armsId, xMoveSpeed, yMoveSpeed, radius]);
      else if(this.headAttrs[i].type == 'Launcher')
        socket.emit('trip', ['trip', bulletX, bulletY, 0, this.armsId, this.bulletDamage]);
    }
  }

  Tank.prototype.autoFireBullet = function() {
    for(let i = 0; i < this.headShapes.length; i++) {
      if(this.headAttrs[i].type != 'Auto')
        continue;
      outWarStartTime = new Date();
      let angle = tools.deg2Rad(this.headShapes[i].rotation);
      let bulletX = this.model.x + this.headAttrs[i].outerRadius * Math.cos(angle);
      let bulletY = this.model.y + this.headAttrs[i].outerRadius * Math.sin(angle);
      let xMoveSpeed = this.maxBulletSpeed * Math.cos(angle);
      let yMoveSpeed = this.maxBulletSpeed * Math.sin(angle);
      let radius = this.headAttrs[i].r;
      socket.emit('fire', ['fire', bulletX, bulletY, 0, this.armsId, xMoveSpeed, yMoveSpeed, radius]);
    }
  }

  // Bullet part
  function Bullet (modelX, modelY, armsId = 4, belong = 0) {
    GeneralModel.call(this, modelX, modelY, armsId);
    this.type = 1;
    this.healthPoint = 1;
    this.belong = belong;
    this.model.scaleX = 0.4;
    this.model.scaleY = 0.4;
    this.bodyDamage = tankMap[belong].bulletDamage;
    this.bonus = 0;
  }

  Bullet.prototype = new GeneralModel();
  Bullet.prototype.constructor = Bullet;

  Bullet.prototype.bulletMove = function() {
    let xTime, yTime, This = this;

    if(this.xMoveSpeed > 0) xTime = (CANVAS_RIGHT - this.model.x) / this.xMoveSpeed;
    else if(this.xMoveSpeed < 0) xTime = (CANVAS_LEFT - this.model.x) / this.xMoveSpeed;
    if(this.yMoveSpeed > 0) yTime = (CANVAS_TOP - this.model.y) / this.yMoveSpeed;
    else if(this.yMoveSpeed < 0) yTime = (CANVAS_BOTTOM - this.model.y) / this.yMoveSpeed;
    let time = Math.min(xTime, yTime);

    let destX = this.model.x + this.xMoveSpeed * time;
    let destY = this.model.y + this.yMoveSpeed * time;

    if(this.belong == maintk.armsId)
      createjs.Tween.get(this.model).to({x: destX, y: destY}, 30 * time).call(handleComplete).
      addEventListener('change', handleChange);
    else
      createjs.Tween.get(this.model).to({x: destX, y: destY}, 30 * time).call(handleComplete);

    function handleChange(event) {
      for(let i = 0; i < tankList.length; i++) {
        if(tankList[i] != maintk && checkCollision(This, tankList[i]) == true)
          return;
      }
      for(let i = 0; i < creepList.length; i++) {
        if(checkCollision(This, creepList[i]) == true)
          return;
      }
    }

    function handleComplete() {
      stage.removeChild(This.model);
      for(let i = 0; i < bulletList.length; i++)
        if(This == bulletList[i]) {
          bulletList.splice(i, 1);
          break;
        }
    };
  }


  // Creep part
  function Creep (modelX, modelY, armsId = 0, belong = 0) {
    GeneralModel.call(this, modelX, modelY, armsId);
    if(this.armsId)
      this.type = 2;
    this.belong = belong;
  }

  Creep.prototype = new GeneralModel();
  Creep.prototype.constructor = Creep;


  // KeyBoard Event & Mouse Event
  var preTime = new Date();
  var autoFire = false;

  document.onkeydown = function(ev) {
    var kEvent = ev || window.event;
    if(kEvent.keyCode == 67)    // 'C'
    {
      let headId = (maintk.armsId >> 4 & 63);
      autoFire = !autoFire;
      console.log('autoFire = ', autoFire);
    }
    else if(kEvent.keyCode == KEYBOARD_UP)
      KEYBOARD_CONDITION |= 8;
    else if(kEvent.keyCode == KEYBOARD_DOWN)
      KEYBOARD_CONDITION |= 4;
    else if(kEvent.keyCode == KEYBOARD_LEFT)
      KEYBOARD_CONDITION |= 2;
    else if(kEvent.keyCode == KEYBOARD_RIGHT)
      KEYBOARD_CONDITION |= 1;
  }

  document.onkeyup = function(ev) {
    var kEvent = ev || window.event;
    if(kEvent.keyCode == KEYBOARD_UP)
      KEYBOARD_CONDITION &= 7;
    else if(kEvent.keyCode == KEYBOARD_DOWN)
      KEYBOARD_CONDITION &= 11;
    else if(kEvent.keyCode == KEYBOARD_LEFT)
      KEYBOARD_CONDITION &= 13;
    else if(kEvent.keyCode == KEYBOARD_RIGHT)
      KEYBOARD_CONDITION &= 14;
  }

  document.onmousemove = function(ev) {
    if(!maintk) return;
    if(autoFire) return;
    var mEvent = ev || window.event;
    let x = Math.round(mEvent.clientX - cvsBox.left - stage.x);
    let y = Math.round(mEvent.clientY - cvsBox.top - stage.y);
    maintk.heads.rotation = tools.vec2Deg(x - maintk.model.x, y - maintk.model.y);
    socket.emit('turn', ['turn', maintk.armsId, maintk.heads.rotation]);
    stage.update();
  }

  document.onmousedown = function(ev) {
    if(!maintk) return;
    if(autoFire) return;
    let curTime = new Date();
    if(curTime - preTime > maintk.bulletReloadInterval) {
      maintk.fireBullet();
      preTime = curTime;
    }
  }


  // Ticker Event
  function turnAndFire(obj) {
    if(!maintk) return;
    let curTime = new Date();
    if(curTime - preTime > maintk.bulletReloadInterval) {
      preTime = curTime;
      let cnt = 0;
      for(let i = 0; i < maintk.headShapes.length; i++)
        if(maintk.headAttrs[i].type == 'Auto') {
          cnt ++;
          maintk.headShapes[i].rotation = 
            tools.vec2Deg(obj.model.x - maintk.model.x, obj.model.y - maintk.model.y);
          if(cnt > 1)
            maintk.headShapes[i].rotation += Math.random() * 360;
          socket.emit('pturn', ['pturn', maintk.armsId, i, maintk.headShapes[i].rotation]);
        }
      stage.update();
      maintk.autoFireBullet();
    }
  }

  function autoFireEvent() {
    if(!maintk) return;
    if(!autoFire) return;
    for(let i = 0; i < tankList.length; i++)
      if(isNear(maintk, tankList[i])) {
        turnAndFire(tankList[i]);
        return;
      }
    for(let i = 0; i < creepList.length; i++)
      if(isNear(maintk, creepList[i])) {
        turnAndFire(creepList[i]);
        return;
      }
  }
  setInterval(autoFireEvent, 100);

  function autoHealthRegenerationEvent() {
    if(!maintk) return;
    maintk.healthPoint += maintk.regenerationRate;
    maintk.healthPoint = Math.min(maintk.healthPoint, maintk.maxHealthPoint);
    socket.emit('HPdrop', ['HPdrop', maintk.armsId, maintk.healthPoint]);
  }
  setInterval(autoHealthRegenerationEvent, 3000);

  var outWarStartTime = new Date();
  function autoDisappear() {
    let curTime = new Date();
    if(curTime - outWarStartTime < 30) {
      maintk.baseAlpha = 1;
      maintk.model.alpha = 1;
      socket.emit('transparent', ['transparent', maintk.armsId, 1]);
      return;
    }
    if(curTime - outWarStartTime > 5000) {
      maintk.baseAlpha -= 0.006;
      if(maintk.baseAlpha < 0)
        maintk.baseAlpha = 0;
      maintk.model.alpha = Math.max(maintk.baseAlpha, 0.2);
      socket.emit('transparent', ['transparent', maintk.armsId, maintk.baseAlpha]);
      return;
    }
  }

  // Handle Server Message
  function find(id) {
    for(let i = 0; i < tankList.length; i++)
      if(tankList[i].armsId == id)
        return tankList[i];
    for(let i = 0; i < bulletList.length; i++)
      if(bulletList[i].armsId == id)
        return bulletList[i];
        for(let i = 0; i < creepList.length; i++)
      if(creepList[i].armsId == id)
        return creepList[i];
    for(let i = 0; i < tripList.length; i++)
      if(tripList[i].armsId == id)
        return creepList[i];
    return 0;
    // alert('Find Nothing');
  }

  function findDelete(id) {
    for(let i = 0; i < tankList.length; i++)
      if(id == tankList[i].armsId) {
        tankList.splice(i, 1);
        return;
      }
    for(let i = 0; i < creepList.length; i++)
      if(id == creepList[i].armsId) {
        creepList.splice(i, 1);
        return;
      }
    for(let i = 0; i < bulletList.length; i++)
      if(id == bulletList[i].armsId) {
        bulletList.splice(i, 1);
        return;
      }
    for(let i = 0; i < tripList.length; i++)
      if(id == tripList[i].armsId) {
        tripList.splice(i, 1);
        return;
      }
  }

  function serverMessage(data) {
    if (serverEvent[data[0]])
      serverEvent[data[0]](data);
  }

  var maintk = null;

  var serverEvent = {
    control: function(data) {
      // console.log('control: maintk id = ', data[1]);
      for(let i = 0; i < tankList.length; i++)
        if(tankList[i].armsId == data[1])
          maintk = tankList[i];
      if(!maintk) alert('ERROR: NO TANK!!!');
      maintk.name = data[2];
      maintk.setBodyColor('', '', 1);
      maintk.decorate(maintk.armsId);
      iw.init(maintk.name, 'Tank', 0, 1, 0);
      createjs.Ticker.addEventListener('tick', function() {
      	if(!maintk) return;
        stage.x = (BODY_WIDTH >> 1) - maintk.model.x;
        stage.y = (BODY_HEIGHT >> 1) - maintk.model.y;
        if(maintk)
          maintk.tankMove();
        stage.update();
      });
    },
    move: function(data) {
      for(let i = 0; i < tankList.length; i++)
        if(tankList[i].armsId == data[1]) {
          tankList[i].model.x = data[2];
          tankList[i].model.y = data[3];
        }
    },
    turn: function(data) {
      for(let i = 0; i < tankList.length; i++)
        if(tankList[i].armsId == data[1])
          tankList[i].heads.rotation = data[2];
    },
    pturn: function(data) {
      let tk = find(data[1]);
      if(!tk) return;
      tk.headShapes[data[2]].rotation = data[3];
    },
    fire: function(data) {
      // ['fire', bulletX, bulletY, bulletId, tankId, xMoveSpeed, yMoveSpeed, r]
      // rule: who fire the bullet, who check the collision.
      let bullet = new Bullet(data[1], data[2], data[3], data[4]);
      if(data[4] != maintk.armsId) {
        bullet.setBodyColor('', '', 5);
        bullet.decorate(bullet.armsId);
      }
      bullet.xMoveSpeed = data[5];
      bullet.yMoveSpeed = data[6];
      bullet.model.scaleX = 0.4 * data[7] / 30;
      bullet.model.scaleY = 0.4 * data[7] / 30;
      bullet.bodyDamage = bullet.bodyDamage * bullet.model.scaleX / 0.4;
      console.log('bulletScale = ', bullet.model.scaleX);
      bullet.decorate(bullet.armsId);
      bulletList.push(bullet);
      bulletMap[data[3]] = bullet;
      stage.addChild(bullet.model);
      bullet.bulletMove();
    },
    trip: function(data) {
      // ['trip', tripX, tripY, tripId, tankId, bodyDamage]
      console.log('tripId = ', data[3]);
      let trip = new Creep(data[1], data[2], data[3], data[4]);
      trip.bonus = 0;
      trip.bodyDamage = data[5];
      if(data[4] != maintk.armsId) {
        trip.setBodyColor('', '', 5);
        trip.decorate(trip.armsId);
      }
      trip.healthPoint = 1;
      trip.maxHealthPoint = 1;
      tripList.push(trip);
      stage.addChild(trip.model);
    },
    collide: function(data) {
      // ['collide', armsId, destX, destY]
      let obj = find(data[1]), destX = data[2], destY = data[3];
      if(!obj) return;
      createjs.Tween.get(obj.model).to({x: destX, y: destY}, 70);
    },
    addTank: function(data) {
      console.log('addtanks bodyDamage = ', data[6]);
      let tank = new Tank(data[2], data[3], data[1]);
      tank.healthPoint = data[4];
      tank.maxHealthPoint = data[5];
      tank.bodyDamage = data[6];
      tank.model.alpha = data[7];
      tank.setHealthCond(data[4] / data[5]);
      tank.setBodyColor('', '', 5);
      tank.decorate(tank.armsId);
      tankList.push(tank);
      tankMap[tank.armsId] = tank;
      stage.addChild(tank.model);
    },
    addCreep: function(data) {
      let creep = new Creep(data[2], data[3], data[1]);
      if((data[1] >> 2 & 3) == 3) // trip
        creep.setBodyColor('', '', 5);
      else
        creep.setBodyColor('', '', Math.floor(Math.random() * 4 + 2));
      creep.decorate(creep.armsId);
      creep.healthPoint = data[4];
      creep.maxHealthPoint = data[5];
      creep.bodyDamage = data[6];
      creep.setHealthCond(data[4] / data[5]);
      if((data[1] >> 2 & 3) == 3) { // trip 
        creep.bonus = 0;
        tripList.push(creep);
      }
      else
        creepList.push(creep);
      // creepMap[creep.armsId] = creep;
      stage.addChild(creep.model);
    },
    killed: function(data) {
      let obj = null;
      for(let i = 0; i < tankList.length; i++)
        if(tankList[i].armsId == data[1]) {
          obj = tankList[i];
          tankList.splice(i, 1);
          break;
        }
      for(let i = 0; i < creepList.length; i++)
        if(creepList[i].armsId == data[1]) {
          obj = creepList[i];
          creepList.splice(i, 1);
          break;
        }
      for(let i = 0; i < bulletList.length; i++)
        if(bulletList[i].armsId == data[1]) {
          obj = bulletList[i];
          bulletList.splice(i, 1);
          break;
        }
      for(let i = 0; i < tripList.length; i++)
        if(tripList[i].armsId == data[1]) {
          obj = tripList[i];
          tripList.splice(i, 1);
          break;
        }
        if(!obj) return;
      console.log(obj, ' is killed.');
      stage.removeChild(obj.model);
      createjs.Tween.removeTweens(obj.model);
      if(obj.armsId == maintk.armsId) {
        pageVueData.gameState = 3;
        gui_show_kill("YOU DIE", "SHOW LOGIN PAGE AFTER 3s");
        //alert('YOU DIE!');
        maintk = null;
      }
    },
    HPdrop: function(data) {
      let obj = find(data[1]);
      if(!obj) return;
      console.log(data[1], ': HP drop');
      if(obj.armsId == maintk.armsId && data[2] < maintk.healthPoint)
        outWarStartTime = new Date();
      obj.healthPoint = data[2];
      obj.setHealthCond(obj.healthPoint / obj.maxHealthPoint);
    },
    upgrade: function(data) {
      let tk = find(data[1]);
      switch(data[2])
      {
        case 0: (tk.regenerationRate += 1); break;
        case 1: (tk.maxHealthPoint += 20); (tk.healthPoint += 20);
          tk.setHealthCond(tk.healthPoint/tk.maxHealthPoint); break;
        case 2: (tk.bodyDamage += 1); break;
        case 3: (tk.maxBulletSpeed += 1); break;
        case 4: (tk.bulletDamage += 10); break;
        case 5: (tk.bulletReloadInterval -= 80); break;
        case 6: (tk.maxMoveSpeed += 1); break;
        case 7: tk.armsId = (tk.armsId & 0xfc00) | data[3];
                tankMap[tk.armsId] = tk;
                tk.decorate(tk.armsId);
                tk.setHealthCond(tk.healthPoint / tk.maxHealthPoint);
                if(tk.armsId == maintk.armsId && ((maintk.armsId >> 4) & 63) == 8) {  // Assassin
                  setInterval(autoDisappear, 30);
                }
                if(tk.armsId == maintk.armsId && ((maintk.armsId >> 4) & 63) == 18) {  // Landmine
                  setInterval(autoDisappear, 30);
                }
                break;
        default: break;
      }
    },
    transparent: function(data) {
      let tk = find(data[1]);
      if(!tk) return;
      tk.model.alpha = data[2];
    }
  };

  // 实例
  socket.on('transparent', serverMessage);
  socket.on('addTank', serverMessage);
  socket.on('addCreep', serverMessage);
  socket.on('control', serverMessage);
  socket.on('upgrade', serverMessage);
  socket.on('collide', serverMessage);
  socket.on('killed', serverMessage);
  socket.on('HPdrop', serverMessage);
  socket.on('pturn', serverMessage);
  socket.on('move', serverMessage);
  socket.on('turn', serverMessage);
  socket.on('fire', serverMessage);
  socket.on('trip', serverMessage);

  Hcanvas.width = BODY_WIDTH;
  Hcanvas.height = BODY_HEIGHT;
  var Hstage = new createjs.Stage('Hcanvas');
  var bm = new BoostMenu(0, BODY_HEIGHT - 200);
  var minimap = new MiniMap(BODY_WIDTH - 200, BODY_HEIGHT - 200, 2000, './images/map_172x172.png');
  var iw = new InfoBar(BODY_WIDTH >> 1, BODY_HEIGHT - 40);
  var tic = 0;
  Hstage.addChild(minimap.model, iw.model);
  createjs.Ticker.framerate = FRAME_RATE;
  createjs.Ticker.addEventListener('tick', function() {
    if(!maintk) return;
    minimap.animateCoord(maintk.model.x, maintk.model.y);
    Hstage.update();
  });
  var updmenu = new UpgradeMenu(10, 10);
  updmenu.setItemOnShow(0, 2<<4, 'Sniper');
  updmenu.setItemOnShow(1, 3<<4, 'Guard');
  updmenu.setItemOnShow(2, 4<<4, 'Twin');
  updmenu.setItemOnShow(3, 5<<4, 'Smasher');
  
  var border = new createjs.Shape();
  border.graphics.ss(4).s('#727272').dr(50, 50, 1900, 1900);
  stage.addChild(border);

</script>
</body>
</html>